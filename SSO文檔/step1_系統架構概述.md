# SSO系統架構概述

## 系統架構圖

```
+---------------------+    +----------------------+    +----------------------+
|                     |    |                      |    |                      |
|  Google OAuth 2.0   |    |   Facebook OAuth     |    |   其他 SSO 提供者    |
|                     |    |                      |    |                      |
+----------+----------+    +-----------+----------+    +----------+-----------+
           |                           |                          |
           |                           |                          |
           v                           v                          v
+----------+---------------------------+-------------+------------+----------+
|                                                                             |
|                           Passport 策略層                                    |
|                                                                             |
|  +---------------+    +----------------+    +---------------------+         |
|  | GoogleStrategy|    | FacebookStrategy|   | 其他 SSO 策略         |         |
|  +-------+-------+    +--------+-------+    +-----------+---------+         |
|          |                     |                        |                   |
+----------+---------------------+------------------------+-------------------+
           |                     |                        |
           |                     |                        |
           v                     v                        v
+----------+---------------------+------------------------+-------------------+
|                                                                             |
|                             SSO 服務層                                       |
|                                                                             |
|  +------------------------------------------------------------------+       |
|  |                       SsoService                                  |       |
|  |                                                                   |       |
|  |  +---------------------+  +-------------------+  +-------------+  |       |
|  |  | validateOrCreateUser|  | linkProviderToUser|  | 其他服務方法  |  |       |
|  |  +---------------------+  +-------------------+  +-------------+  |       |
|  |                                                                   |       |
|  +------------------------------------------------------------------+       |
|                                      |                                      |
+--------------------------------------+--------------------------------------+
                                       |
                                       v
+--------------------------------------+--------------------------------------+
|                                                                             |
|                             使用者資料儲存層                                  |
|                                                                             |
|  +---------------------------+      +----------------------------+          |
|  |         User 模型          |      |    UserSsoConnection 模型   |          |
|  |                           +----->+                            |          |
|  |  - id                     |      |  - id                      |          |
|  |  - email                  |      |  - userId                  |          |
|  |  - firstName              |      |  - provider                |          |
|  |  - lastName               |      |  - providerId              |          |
|  |  - role                   |      |  - createdAt               |          |
|  |  - ...其他欄位              |      |  - updatedAt               |          |
|  +---------------------------+      +----------------------------+          |
|                                                                             |
+--------------------------------------+--------------------------------------+
                                       |
                                       v
+--------------------------------------+--------------------------------------+
|                                                                             |
|                             API 控制器層                                     |
|                                                                             |
|  +---------------------------+      +----------------------------+          |
|  |      SsoController        |      |       AuthController       |          |
|  |                           |      |                            |          |
|  |  - /auth/google           |      |  - /auth/login            |          |
|  |  - /auth/facebook         |      |  - /auth/register         |          |
|  |  - /auth/github           |      |  - /auth/profile          |          |
|  |  - ...其他 SSO 路由         |      |  - ...其他身分驗證路由       |          |
|  +---------------------------+      +----------------------------+          |
|                                                                             |
+--------------------------------------+--------------------------------------+
                                       |
                                       v
+--------------------------------------+--------------------------------------+
|                                                                             |
|                               前端應用程式                                    |
|                                                                             |
|  +---------------------------+      +----------------------------+          |
|  |       登入頁面             |      |        使用者管理頁面         |          |
|  |                           |      |                            |          |
|  |  [Google 登入按鈕]         |      |  - 顯示連結的 SSO 提供者      |          |
|  |  [Facebook 登入按鈕]       |      |  - 管理提供者連結            |          |
|  |  [其他 SSO 按鈕]           |      |  - 帳號設定                 |          |
|  +---------------------------+      +----------------------------+          |
|                                                                             |
+-----------------------------------------------------------------------------+
```

在這個架構中，我們可以看到整個SSO系統由多個層次組成：

1. **最上層**：各種SSO提供者 (Google, Facebook, 其他)
2. **Passport策略層**：整合各種提供者的專用策略
3. **SSO服務層**：處理用戶驗證和資料轉換邏輯
4. **使用者資料儲存層**：定義User和UserSsoConnection資料模型
5. **API控制器層**：提供REST API端點
6. **前端應用程式**：用戶界面呈現

這種分層架構確保了系統的可維護性和擴展性，使得新增其他SSO提供者變得簡單。