# SSO登入流程設計

## 登入流程圖

```
+------------------+          +------------------+          +------------------+
|                  |          |                  |          |                  |
|   使用者/瀏覽器    +--------->+   NestJS 後端    +--------->+  SSO 提供者 (例如  |
|                  |  1. 點擊  |                  | 2. 重定向  |  Google)         |
+--------+---------+  SSO按鈕  +--------+---------+          +--------+---------+
         ^                             |                              |
         |                             |                              |
         |                             |                              |
         |                             |                              |
         |                    6. 返回JWT|                              |
         |                       Token |                              |
         |                             |                              v
+--------+---------+          +--------+---------+          +------------------+
|                  |          |                  |          |                  |
|   前端應用程式     |<---------+   NestJS 後端    |<---------+  SSO 提供者       |
|                  | 5. 重定向  |                  | 3. 使用者  |                  |
+------------------+ 到前端頁面 +--------+---------+ 同意授權後 +------------------+
                                        |           回調 API
                                        |
                                        v
                             +------------------+
                             |                  |
                             |  資料庫 (儲存/更新 |
                             |  使用者資訊)      |
                             |                  |
                             +------------------+
                                        |
                                        | 4. 建立/更新使用者
                                        |    產生 JWT Token
                                        v
```

## 流程說明

1. **使用者點擊SSO按鈕**：
   - 使用者在前端應用程式點擊 "使用Google登入" 或其他SSO提供者的按鈕
   - 前端應用程式導向後端API (例如 `/auth/google`)

2. **後端重定向到SSO提供者**：
   - NestJS API收到請求後，產生安全的隨機state值並儲存
   - 將使用者重定向到SSO提供者的授權頁面
   - 附加必要參數：client_id, redirect_uri, scope, state等

3. **使用者在SSO提供者頁面授權**：
   - 使用者在SSO提供者頁面進行身分驗證(如需要)
   - 使用者同意授與應用程式存取權限
   - SSO提供者將使用者重定向回我們的callback URL (例如 `/auth/google/callback`)
   - 授權碼會附加在回調URL中

4. **後端處理回調**：
   - 驗證state參數，防止CSRF攻擊
   - 使用授權碼向SSO提供者交換訪問令牌
   - 用訪問令牌獲取使用者資訊
   - 在資料庫中查找或建立使用者記錄
   - 如有需要，更新使用者資訊或建立SSO連結記錄
   - 產生JWT Token

5. **重定向回前端**：
   - 將JWT Token附加在URL參數中
   - 重定向使用者回前端應用程式的特定頁面

6. **前端處理登入成功**：
   - 前端接收並儲存JWT Token
   - 使用Token進行後續的API請求

## 安全考量

1. **使用state參數**：
   - 每次SSO登入請求都生成唯一的state值
   - 回調時驗證state值，確保請求來源一致
   - 設定state的時效性，通常為5-10分鐘

2. **HTTPS通訊**：
   - 所有的OAuth通訊必須通過HTTPS進行
   - 確保callback URL也是HTTPS

3. **JWT安全設定**：
   - 設定合理的Token有效期限
   - 使用強密鑰簽名
   - 考慮實作Token刷新機制